<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAtozww5bfNzP-MXagYbLAr9gT6wTgHYdg&sensor=false">
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script>
      if (typeof Number.prototype.toRad == 'undefined') {
	Number.prototype.toRad = function() {
	  return this * Math.PI / 180;
	}
      }
      if (typeof Number.prototype.toDeg == 'undefined') {
	Number.prototype.toDeg = function() {
	  return this * 180 / Math.PI;
	}
      }
    </script>
     
    <script type="text/javascript">
      function initialize() {
	var mapOptions = {
	center: new google.maps.LatLng(-34.397, 150.644),
	zoom: 8,
	mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      var map = new google.maps.Map(document.getElementById("map-canvas"),
	mapOptions);
      }
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <script>
      var bikeOldLatDeg, bikeOldLngDeg, bikeLatAvgDeg, bikeLngAvgDeg;

      window.setInterval(function() {
	$.getJSON( 'http://api.citybik.es/capitalbikeshare.json?callback=dojsonp')
	  .done(function(msg) {
	  var bikeLatAccE6 = 0, bikeLngAccE6 = 0, dockLatAccE6 = 0, dockLngAccE6 = 0,
	  bikesAcc = 0, docksAcc = 0;
	var R, dLat, dLon, a, c, d;

	$.each(msg, function(index, value) {
	  var bikes = value.bikes;
	  var docks = value.free;
	  bikesAcc += bikes;
	  bikeLatAccE6 += bikes * value.lat;
	  bikeLngAccE6 += bikes * value.lng;
	  docksAcc += docks;
	  dockLatAccE6 += docks * value.lat;
	  dockLngAccE6 += docks * value.lng;
	});
	bikeLatAvgDeg = 0.000001 * bikeLatAccE6 / bikesAcc;
	bikeLngAvgDeg = 0.000001 * bikeLngAccE6 / bikesAcc;
	dockLatAvgDeg = 0.000001 * dockLatAccE6 / docksAcc;
	dockLngAvgDeg = 0.000001 * dockLngAccE6 / docksAcc;

	R = 6371 / 1.609344; // miles
	dLat = 0;
	dLng = 0;
	if (bikeOldLatDeg !== undefined && bikeOldLngDeg !== undefined) {
	  dLat = (bikeLatAvgDeg - bikeOldLatDeg).toRad();
	  dLon = (bikeLngAvgDeg - bikeOldLngDeg).toRad();
	} else {
	  bikeOldLatDeg = bikeLatAvgDeg;
	  bikeOldLngDeg = bikeLngAvgDeg;
	}

	a = Math.sin(dLat/2) * Math.sin(dLat/2) +
	  Math.sin(dLon/2) * Math.sin(dLon/2) *
	  Math.cos(bikeOldLatDeg.toRad()) * Math.cos(bikeOldLngDeg.toRad()); 
	d = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 

	console.log('Bike Status for Capital Bikeshare:');
	console.log('Timestamp\t\tBikes\tDocks\tBike center\Dock center\tdelta');
	console.log(msg[0].timestamp + ': '
	  + bikesAcc +'\t' + docksAcc
	  + '\t' + bikeLatAvgDeg.toFixed(2)
	  + ', ' + bikeLngAvgDeg.toFixed(2)
	  + '\t' + dockLatAvgDeg.toFixed(2)
	  + ', ' + dockLngAvgDeg.toFixed(2)
	  + '\t' + d);
	bikeOldLatDeg = bikeLatAvgDeg;
	bikeOldLngDeg = bikeLngAvgDeg;
      })
      .fail(function(jqXHR, textStatus) {
	console.log("Request failed: " + textStatus);
      });
    },3000);
    </script>
    <div id="map-canvas"/>
  <script class="jsonp"></script>
  </body>
</html>
